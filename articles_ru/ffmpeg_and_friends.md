## FFMPEG and Friends

Всё таки как-то уныло ехать в маршрутке. Люди с серьёзными лицами держатся за поручни и задумчиво смотрят в окно. Ведь это очень серьёзное занятие, недайбох что — передать деньги за проезд с задней двери. Или если вдруг открыть/закрыть окно или люк. Чтоб как-то отвлечься от этой повседневной суеты, сначала слушал музыку, всё было хорошо, пока я не запилил абсолютно всю музыку которая у меня была, до дыр. И вот мне в голову пришла замечательная идея, а почему бы не смотреть видео? Оооо, точно! Всё таки клёво когда дома есть отдельный сервер. Мне не нужно бдить или оставлять свой комп включенным, пока я сплю или где-то шастаю, мини сервер тихо шуршит электронами. На сервер было залито видео с конференции. И при помощи не хитрого скрипта, преобразовано для телефона.

``` sh
#!/bin/bash

#### Setup ####
# Эта опция указывает в какой директории лежат видео файлы
# которые следует конвертировать
DIR="/var/media/video/Planetes/"

# А эта опция указывает папку в которую следует сохранять 
# сконвертированное видео
SAVE="/var/media/video/phone/Planetes/"

# Эта переменная определяет формат видео файлов которые следует
# конвертировать
FORMAT_TYPE="mkv"
###############

IFS=$'\n'
# Стоит заметить, что этот скрипт осуществляет поиск видео
# по всем папкам и подпакам
for i in `find $DIR -depth -iname *.$FORMAT_TYPE -type f`
do
name=`basename "$i" .$FORMAT_TYPE`
    if [ -e "$SAVE/$name.mp4" ]
    then
    echo "all fine" > /dev/null
    else

    # Стоит обратить внимание на параметр -threads 4
    # люди из форумов советуют ставить его равным количеству
    # процессоров/ядер компьютера
    ffmpeg -v 0 -y -threads 4 -i "$i" -r 29.97 -vcodec libx264 -s 480x272 -flags +loop -cmp +chroma -deblockalpha 0 -deblockbeta 0 -crf 24 -bt 256k -refs 1 -coder 0 -me_method umh -me_range 16 -subq 5 -partitions +parti4x4+parti8x8+partp8x8 -g 250 -keyint_min 25 -level 30 -qmin 10 -qmax 51 -trellis 2 -sc_threshold 40 -i_qfactor 0.71 -acodec libfaac -ab 128k -ar 48000 -ac 2 $SAVE/$name.mp4 1>/dev/null 2>/dev/null
    fi
done
```

Этот скрипт конвертирует видео в формат `.mp4`, понятном для телефона, из любого другого не понятного формата. Например моя Nokla тоже прекрасно воспроизводит эти файлы. Так вот, как обычно бывает, счастье не могло длится вечно и всё видео с конференций я пересмотрел. Тогда я решил сконвертить остальное видео. Но с остальным видео одна проблема, очень часто в этом видео несколько audio потоков, например перевод на разных языках. И по умолчанию конвертируется не всегда тот что нужен. В таком случае, нужно понять какой именно поток нам нужен. Узнать это можно при помощи всё того же ffmpeg:

``` sh
$ ffmpeg -i Planetes_01.mkv
[ шум вырезан ]
    Stream #0.0: Video: mpeg4, yuv420p, 1280x720 [PAR 1:1 DAR 16:9], 23.98 tbr, 1k tbn, 23.98 tbc
    Stream #0.1(rus): Audio: vorbis, 48000 Hz, stereo, s16
    Stream #0.2(jpn): Audio: vorbis, 48000 Hz, stereo, s16
    Stream #0.3(rus): Subtitle: 0x0000
```

Вот, видим четыре потока: видео, русский, японский и субтитры. В таком случае, скрипт немного изменится, добавится опция `-map 0:0 -map 0:1` которая указывает какие потоки должны быть на выходе.

``` sh
ffmpeg -v 0 -y -threads 4 -i "$i" -map 0:0 -map 0:1 -r 29.97
```

Опция `-map` указана дважды, **первым мапится видео поток, вторым аудио**. В данном случае меня интересует русский язык, поток **#1** `Stream #0.1(rus)`.  Например, если я захочу слушать японский язык, то следует выбрать второй поток `-map 0:2`. Если видео поток не мапить, то он и не сохранится в результирующем файле.
